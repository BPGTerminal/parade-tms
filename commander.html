<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Parade+TMS%22%2C%22short_name%22%3A%22Parade+TMS%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0e1a%22%2C%22theme_color%22%3A%22%2300e5ff%22%7D">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EOC Commander Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0a0e1a; --panel:#0f1628; --border:#1e3a5f;
    --accent:#00e5ff; --accent2:#ff6b35; --green:#00ff88;
    --text:#c8d8e8; --dim:#4a6080; --red:#ff3b5c;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:var(--bg);color:var(--text);font-family:'Barlow Condensed',sans-serif;
    height:100vh;overflow:hidden;display:grid;
    grid-template-rows:54px 1fr;
    grid-template-columns:1fr 330px;
    transition:grid-template-columns .3s;
  }
  body.map-maximized{
    grid-template-columns:1fr 0;
  }
  body.map-maximized aside{
    display:none;
  }
  /* HEADER */
  header{
    grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;padding:0 16px;
  }
  .hdr-left{display:flex;align-items:center;gap:10px;}
  .eoc-badge{background:var(--accent);color:#000;font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:bold;padding:3px 8px;letter-spacing:1px;}
  header h1{font-size:17px;font-weight:700;letter-spacing:2px;color:#fff;text-transform:uppercase;}
  header h1 span{color:var(--accent);}
  .hdr-right{display:flex;align-items:center;gap:18px;font-family:'Share Tech Mono',monospace;font-size:12px;}
  #clock{color:var(--accent);letter-spacing:1px;}
  .live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-right:5px;animation:blink 1.5s infinite;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  .admin-link{color:var(--dim);text-decoration:none;font-size:11px;letter-spacing:1px;border:1px solid var(--border);padding:3px 8px;transition:all .2s;}
  .admin-link:hover{color:var(--accent);border-color:var(--accent);}
  /* MAP */
  #map{background:#07101f;padding-bottom:46px;}
  .leaflet-tile{filter:brightness(.7) saturate(.5) hue-rotate(200deg);}
  .leaflet-tile.satellite{filter:none;}
  .leaflet-tile.plain{filter:none;}
  /* SIDEBAR */
  aside{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
  .panel-hdr{background:rgba(0,229,255,.06);border-bottom:1px solid var(--border);padding:8px 14px;font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:2px;color:var(--accent);text-transform:uppercase;display:flex;justify-content:space-between;align-items:center;}
  /* TEAM FILTER */
  #team-filters{display:flex;gap:0;border-bottom:1px solid var(--border);}
  .tf-btn{flex:1;background:none;border:none;border-right:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;padding:7px 4px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
  .tf-btn:last-child{border-right:none;}
  .tf-btn.active,.tf-btn:hover{background:rgba(0,229,255,.1);color:var(--accent);}
  /* PERSONNEL */
  #personnel-list{max-height:42%;overflow-y:auto;padding:6px;border-bottom:1px solid var(--border);}
  .p-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-left:3px solid var(--dim);margin-bottom:5px;padding:7px 10px;cursor:pointer;transition:all .2s;}
  .p-card:hover{background:rgba(0,229,255,.05);border-color:var(--accent);}
  .p-card.online{border-left-color:var(--green);}
  .p-card.selected{background:rgba(0,229,255,.09);border-color:var(--accent);}
  .pc-name{font-weight:700;font-size:14px;color:#fff;}
  .pc-team{font-size:11px;margin-top:1px;font-weight:600;}
  .pc-post{font-size:11px;color:var(--dim);margin-top:1px;}
  .pc-status{font-size:10px;font-family:'Share Tech Mono',monospace;margin-top:3px;}
  .pc-status.on{color:var(--green);}
  .pc-status.off{color:var(--dim);}
  .pc-time{font-size:10px;color:var(--dim);}
  .pc-actions{display:flex;gap:5px;margin-top:5px;}
  .pc-btn{flex:1;background:rgba(0,229,255,.08);border:1px solid var(--border);color:var(--accent);font-size:9px;font-family:'Share Tech Mono',monospace;padding:4px;cursor:pointer;letter-spacing:1px;transition:all .2s;}
  .pc-btn:hover{background:var(--accent);color:#000;}
  /* MESSAGES */
  #msg-log{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px;}
  .msg-item{border:1px solid var(--border);padding:7px 10px;font-size:12px;animation:fadeIn .3s;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
  .msg-item.commander{border-left:3px solid var(--accent2);}
  .msg-item.personnel{border-left:3px solid var(--green);}
  .msg-item.system{border-left:3px solid var(--dim);opacity:.65;}
  .msg-hdr{display:flex;justify-content:space-between;margin-bottom:3px;}
  .msg-sender{font-weight:700;font-size:11px;color:var(--accent);}
  .msg-time{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);}
  .msg-photo{margin-top:5px;width:100%;border:1px solid var(--border);cursor:pointer;max-height:110px;object-fit:cover;border-radius:1px;}
  /* COMPOSE */
  .compose{border-top:1px solid var(--border);padding:8px;background:rgba(0,0,0,.2);}
  .compose-target{font-size:11px;font-family:'Share Tech Mono',monospace;color:var(--dim);margin-bottom:5px;}
  .compose-target span{color:var(--accent2);}
  .compose-row{display:flex;gap:5px;}
  #cmd-input{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text);font-family:'Barlow Condensed',sans-serif;font-size:14px;padding:7px 10px;outline:none;}
  #cmd-input:focus{border-color:var(--accent);}
  #cmd-input::placeholder{color:var(--dim);}
  #send-btn{background:var(--accent2);border:none;color:#fff;font-family:'Share Tech Mono',monospace;font-size:11px;padding:0 12px;cursor:pointer;letter-spacing:1px;}
  /* JITSI VIDEO CONFERENCE */
  #jitsi-section{border-top:1px solid var(--border);}
  #jitsi-hdr{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;cursor:pointer;user-select:none;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--accent);background:rgba(0,229,255,.05);}
  #jitsi-hdr:hover{background:rgba(0,229,255,.1);}
  .jitsi-dot{width:7px;height:7px;border-radius:50%;background:#444;display:inline-block;margin-right:5px;}
  .jitsi-dot.live{background:#ff4444;animation:pulse 1s infinite;}
  #jitsi-body{display:none;padding:6px;background:rgba(0,0,0,.25);}
  #jitsi-body.open{display:block;}
  .jitsi-row{display:flex;gap:4px;margin-bottom:5px;}
  #jitsi-room-in{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:10px;padding:4px 7px;outline:none;letter-spacing:1px;}
  #jitsi-room-in:focus{border-color:var(--accent);}
  .jbtn{background:rgba(0,229,255,.08);border:1px solid var(--border);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:9px;padding:4px 9px;cursor:pointer;letter-spacing:1px;transition:all .2s;white-space:nowrap;}
  .jbtn:hover{background:var(--accent);color:#000;}
  .jbtn.red{border-color:#ff4444;color:#ff4444;}
  .jbtn.red:hover{background:#ff4444;color:#fff;}
  #jitsi-wrap{width:100%;background:#000;border:1px solid var(--border);position:relative;min-height:140px;display:flex;align-items:center;justify-content:center;}
  #jitsi-wrap iframe{width:100%;height:180px;border:none;display:block;}
  #jitsi-idle{color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:10px;text-align:center;padding:16px 8px;letter-spacing:1px;}
  
  /* PHOTO MODAL */
  #photo-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;align-items:center;justify-content:center;}
  #photo-modal.show{display:flex;flex-direction:column;align-items:center;}
  .photo-fallback{display:flex;align-items:center;justify-content:center;background:rgba(0,229,255,.1);border:1px solid var(--accent);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:11px;padding:8px 14px;text-decoration:none;letter-spacing:1px;margin-top:6px;}
  .msg-photo-wrap{margin-top:6px;}
  #photo-modal img{max-width:90vw;max-height:90vh;border:2px solid var(--accent);}
  #pm-close{position:absolute;top:20px;right:24px;color:var(--accent);font-size:28px;cursor:pointer;font-family:'Share Tech Mono',monospace;}
  /* SCROLLBAR */
  ::-webkit-scrollbar{width:3px;}
  ::-webkit-scrollbar-thumb{background:var(--border);}
  .empty{color:var(--dim);font-size:12px;font-family:'Share Tech Mono',monospace;text-align:center;padding:16px;}
  /* LEGEND */
  #legend{position:absolute;bottom:24px;left:12px;z-index:500;background:rgba(5,8,16,.28);border:none;padding:6px 10px;font-family:'Share Tech Mono',monospace;font-size:9px;backdrop-filter:none;}
  .leg-item{display:flex;align-items:center;gap:5px;margin-bottom:2px;}
  .leg-dot{width:8px;height:8px;border-radius:50%;border:1px solid rgba(255,255,255,.2);flex-shrink:0;}
  /* MARKER */
  /* .p-marker base ‚Äî overridden by new CSS block below */
  @keyframes pulse{0%,100%{box-shadow:0 0 8px rgba(0,255,136,.5)}50%{box-shadow:0 0 20px rgba(0,255,136,1),0 0 40px rgba(0,255,136,.3)}}


  /* ============================================================
     MAP CONTROLS ‚Äî left side, compact, above Leaflet (z-index 400+)
     ============================================================ */
  #map { position:relative; overflow:hidden; }

  #map-controls {
    position:absolute;
    top:10px;
    left:60px;               /* clear of zoom controls */
    z-index:1000;
    display:flex;
    flex-direction:row;      /* side by side */
    gap:4px;
    align-items:flex-start;
    pointer-events:none;     /* let map clicks through between buttons */
  }
  #map-max-btn, #layer-toggle-btn {
    pointer-events:all;
    background:rgba(5,8,16,.38);
    border:1px solid rgba(0,229,255,.25);
    color:#00e5ff;
    font-family:'Share Tech Mono',monospace;
    font-size:9px;
    letter-spacing:1px;
    padding:4px 8px;
    cursor:pointer;
    white-space:nowrap;
    line-height:1.4;
  }
  #map-max-btn:hover, #layer-toggle-btn:hover {
    background:rgba(0,229,255,.15);
    border-color:#00e5ff;
  }

  /* wrapper gives the panel an anchor point */
  #layer-wrapper {
    position:relative;
    pointer-events:all;
  }
  #layer-panel {
    position:absolute;
    top:calc(100% + 2px);
    left:0;
    width:160px;
    background:rgba(5,8,16,.97);
    border:1px solid #1e3a5f;
    padding:4px 0;
    display:none;
    z-index:1001;
  }
  #layer-panel.open { display:block; }

  .lp-section { padding:2px 0; border-bottom:1px solid #0f2035; }
  .lp-section:last-child { border-bottom:none; }
  .lp-label {
    font-family:'Share Tech Mono',monospace;
    font-size:7px;
    color:#4a6080;
    letter-spacing:1px;
    padding:3px 8px 1px;
    text-transform:uppercase;
  }
  .lp-row {
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 8px;
    cursor:pointer;
    font-family:'Share Tech Mono',monospace;
    font-size:9px;
    color:#8aa8c8;
  }
  .lp-row:hover { background:rgba(0,229,255,.08); color:#00e5ff; }
  .lp-check {
    width:10px;
    height:10px;
    border:1px solid #1e3a5f;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:7px;
    flex-shrink:0;
    line-height:1;
  }
  .lp-check.on        { border-color:#00e5ff; color:#00e5ff; }
  .lp-check.hazard-on { border-color:#ff9900; color:#ff9900; }
  .lp-name { font-size:9px; }
  .lp-opacity { flex:1; accent-color:#00e5ff; height:3px; }

  /* Shrink Leaflet attribution badge */
  .leaflet-control-attribution {
    font-size:7px !important;
    padding:1px 4px !important;
    background:transparent !important;
    color:#c0d8f0 !important;
    max-width:200px;
    text-shadow:0 0 4px rgba(0,0,0,0.9),0 1px 3px rgba(0,0,0,1) !important;
    box-shadow:none !important;
    opacity:0.6;
  }
  .leaflet-control-attribution a { color:#c0d8f0 !important; }

  /* FOOTER transition for fade cycle */
  #pagong-footer { transition:opacity 1s ease; }

  /* PERSONNEL MARKER ‚Äî half size */
  .p-marker {
    width:18px !important;
    height:18px !important;
    border-radius:50%;
    border:2px solid rgba(255,255,255,.7) !important;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:7px !important;
    font-weight:bold;
    color:#000;
    box-shadow:0 0 6px rgba(255,255,255,.25) !important;
  }

</style>
</head>
<body>

<header>
  <div class="hdr-left">
    <div class="eoc-badge">EOC</div>
    <h1 id="hdr-title">Traffic Management <span>// Commander</span></h1>
  </div>
  <div class="hdr-right">
    <span><span class="live-dot"></span>LIVE</span>
    <span id="clock">--:--:--</span>
    <span id="online-badge">0 ONLINE</span>
    <a class="admin-link" href="admin.html">‚öô ADMIN</a>
  </div>
</header>

<div id="map">
  <!-- Map Controls: left side, stacked, compact -->
  <div id="map-controls">
    <button id="map-max-btn"
      onclick="event.stopPropagation();toggleMapMax()"
      title="Toggle fullscreen map">&#9636; MAXIMIZE</button>
    <div id="layer-wrapper">
      <button id="layer-toggle-btn"
        onclick="event.stopPropagation();toggleLayerPanel()">&#128506; LAYERS &#9662;</button>
      <div id="layer-panel" onclick="event.stopPropagation()">
        <div class="lp-section">
          <div class="lp-label">BASE MAP</div>
          <div class="lp-row" onclick="event.stopPropagation();setLayer('street')">
            <div class="lp-check on" id="chk-street">&#10003;</div>
            <span class="lp-name">Street Map</span>
          </div>
          <div class="lp-row" onclick="event.stopPropagation();setLayer('satellite')">
            <div class="lp-check" id="chk-satellite"></div>
            <span class="lp-name">Satellite</span>
          </div>
          <div class="lp-row" onclick="event.stopPropagation();setLayer('topo')">
            <div class="lp-check" id="chk-topo"></div>
            <span class="lp-name">Terrain/Topo</span>
          </div>
        </div>
        <div class="lp-section">
          <div class="lp-label">HAZARD OVERLAY</div>
          <div class="lp-row" onclick="event.stopPropagation();toggleHazard('flood')">
            <div class="lp-check" id="chk-flood"></div>
            <span class="lp-name">Flood</span>
          </div>
          <div class="lp-row" onclick="event.stopPropagation();toggleHazard('landslide')">
            <div class="lp-check" id="chk-landslide"></div>
            <span class="lp-name">Landslide</span>
          </div>
          <div class="lp-row" onclick="event.stopPropagation();toggleHazard('storm')">
            <div class="lp-check" id="chk-storm"></div>
            <span class="lp-name">Storm Surge</span>
          </div>
          <div style="padding:4px 8px 4px;display:flex;align-items:center;gap:6px;">
            <span style="font-family:'Share Tech Mono',monospace;font-size:7px;color:#4a6080;">OPACITY</span>
            <input type="range" class="lp-opacity" id="hazard-opacity" min="10" max="90" value="65"
              oninput="event.stopPropagation();setHazardOpacity(this.value)" onclick="event.stopPropagation()"/>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Hazard Legend -->
  <div id="hazard-legend">
    <div class="leg-title" id="leg-title">HAZARD LEGEND</div>
    <div id="leg-rows"></div>
  </div>
  <div id="legend"></div>
</div>

<aside>
  <div class="panel-hdr">
    Personnel
    <span style="color:var(--green);font-size:10px;" id="online-count">0 / 0</span>
  </div>
  <div id="team-filters"></div>
  <div id="personnel-list"><div class="empty">Waiting for personnel...</div></div>

  <div class="panel-hdr">
    Comms Log
    <span style="color:var(--dim);font-size:10px;">AUTO-SAVED</span>
  </div>
  <div id="msg-log"><div class="empty">No messages yet.</div></div>

  <div class="compose">
    <div class="compose-target">FROM: <span style="color:var(--green)" id="commander-label">PAGONG</span> &nbsp;|&nbsp; TO: <span id="target-label">ALL PERSONNEL</span></div>
    <div class="compose-row">
      <input type="text" id="cmd-input" placeholder="Type message or command..."/>
      <button id="send-btn" onclick="sendMessage()">SEND</button>
    </div>
  </div>

  <!-- JITSI VIDEO / VOICE CONFERENCE -->
  <div id="jitsi-section">
    <div id="jitsi-hdr" onclick="toggleJitsi()">
      <span><span class="jitsi-dot" id="jitsi-dot"></span>üìπ VIDEO CONFERENCE</span>
      <span id="jitsi-hdr-status" style="font-size:9px;color:var(--dim);">IDLE ‚ñº</span>
    </div>
    <div id="jitsi-body">
      <div class="jitsi-row">
        <input id="jitsi-room-in" type="text" placeholder="Room name (e.g. PARADE26-EOC)" value="PARADE26-EOC"/>
        <button class="jbtn" onclick="joinJitsi()">JOIN</button>
        <button class="jbtn red" onclick="leaveJitsi()">END</button>
      </div>
      <div id="jitsi-wrap">
        <div id="jitsi-idle">‚ñ∂ Enter a room name and press JOIN<br/>to start a free video call</div>
      </div>
    </div>
  </div>
</aside>

<div id="photo-modal">
  <span id="pm-close" onclick="closePhoto()">‚úï</span>
  <img id="pm-img" src="" alt="Situation photo"/>
  <a id="pm-fallback" href="#" target="_blank" style="display:none;color:#fff;font-family:'Share Tech Mono',monospace;font-size:13px;margin-top:10px;">üì∑ Open in Google Drive</a>
</div>

<script>
// ============================================================
// ============================================================
// CONFIG ‚Äî loads from localStorage cache (populated by Admin)
// Falls back to hardcoded defaults if nothing saved yet
// ============================================================
const HARDCODED_URL = "https://script.google.com/macros/s/AKfycbwPQzBODQphcsr5XGbCnUdi542wxJOtcJPkSpl9FCyERs_8biTtPgOrN4vLGNXv00phjQ/exec";

function loadConfig(){
  try {
    const s = localStorage.getItem('tms_config');
    const cfg = s ? JSON.parse(s) : null;
    if (cfg && cfg.sheetUrl) return cfg;
  } catch(e){}
  // Return hardcoded defaults
  return {
    eventName: "Pista i ang Kanyog'an",
    eventDate: '08-23 March 2026',
    commander: 'PAGONG',
    unit: 'TRAFFIC MANAGEMENT TEAM',
    lat: 8.7891, lng: 117.8370,
    sheetUrl: HARDCODED_URL,
    teams: [
      {name:'PARADE TEAM',       code:'PARADE26', color:'#00e5ff'},
      {name:'EVENT CENTER TEAM', code:'CENTER26', color:'#00ff88'},
      {name:'MOBILE TEAM',       code:'MOBILE26', color:'#ff6b35'}
    ]
  };
}

// Fetch fresh settings from Sheet and refresh page config
async function refreshConfigFromSheet() {
  try {
    const url = CFG.sheetUrl || HARDCODED_URL;
    const res = await fetch(url + '?action=getSettings');
    const data = await res.json();
    const cfg = data.settings;
    if (!cfg) return;
    // Update cache
    const merged = {...CFG, ...cfg, sheetUrl: url};
    if (Array.isArray(cfg.teams)) merged.teams = cfg.teams;
    localStorage.setItem('tms_config', JSON.stringify(merged));
    // Update visible elements
    const title = `${merged.eventName||'Parade TMS'} <span>// ${merged.commander||'PAGONG'}</span>`;
    const el = document.getElementById('event-title');
    if (el) el.innerHTML = title;
    document.title = `EOC Dashboard ‚Äî ${merged.eventName||'TMS'}`;
  } catch(e){ console.log('Config refresh skipped:', e.message); }
}

const CFG = loadConfig();
const SHEET_URL = CFG.sheetUrl;
const REFRESH = 5000;

// ============================================================
// STATE
// ============================================================
let personnelData = {};
let markers = {};
let selectedTarget = 'ALL';
let selectedTeamFilter = 'ALL';
let map;
let logEntries = [];
let messageCache = new Set();

// ============================================================
// INIT
// ============================================================
function init(){
  updateHeader();
  initMap();
  buildTeamFilters();
  buildLegend();
  startClock();
  fetchUpdates();
  setInterval(fetchUpdates, REFRESH);
  // Pull fresh settings from Sheet every 30s so admin changes reflect
  refreshConfigFromSheet();
  setInterval(refreshConfigFromSheet, 30000);
  // Refresh config display every 10s so admin changes reflect immediately
  setInterval(function(){
    try {
      const fresh = JSON.parse(localStorage.getItem('tms_config'));
      if(fresh) {
        const title = `${fresh.eventName||'Parade TMS'} <span>// ${fresh.commander||'COMMANDER'}</span>`;
        document.getElementById('event-title').innerHTML = title;
        const cmdLabel = document.getElementById('commander-label');
        if(cmdLabel) cmdLabel.textContent = fresh.commander||'PAGONG';
        document.title = `EOC Dashboard ‚Äî ${fresh.eventName||'TMS'}`;
        if(!SHEET_URL && fresh.sheetUrl) location.reload(); // reload if URL just got added
      }
    } catch(e){}
  }, 10000);
  document.getElementById('cmd-input').addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });
  // restore log from session
  const saved = localStorage.getItem('parade_log_session');
  if(saved){ JSON.parse(saved).forEach(m=>addMessage(m,false)); }
}

function updateHeader(){
  const title = CFG.eventName ? `${CFG.eventName} <span>// Commander</span>` : `Traffic Management <span>// Commander</span>`;
  document.getElementById('hdr-title').innerHTML = title;
  document.title = `EOC Dashboard ‚Äî ${CFG.eventName || 'TMS'}`;
}

// ============================================================
// MAP LAYERS
// ============================================================
const TILE_LAYERS = {
  street: {
    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    attr: '¬© OpenStreetMap', maxZoom:19,
    filter: 'brightness(.75) saturate(.5) hue-rotate(200deg)'
  },
  satellite: {
    url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
    attr: '¬© Google Maps', maxZoom:20,
    filter: 'brightness(.9) saturate(.9)'
  },
  topo: {
    url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    attr: '¬© OpenTopoMap', maxZoom:17,
    filter: 'brightness(.75) saturate(.4) hue-rotate(180deg)'
  }
};

// PHIVOLCS Hazard Hunter WMS layers
const HAZARD_LAYERS = {
  flood: {
    url: 'https://hazardhunter.georisk.gov.ph/geoserver/hazardhunter/wms',
    layers: 'hazardhunter:fh_100yr',
    label: 'FLOOD HAZARD (100yr)',
    legend: [{color:'#ff0000',label:'High'},{color:'#ff8800',label:'Medium'},{color:'#ffff00',label:'Low'}]
  },
  landslide: {
    url: 'https://hazardhunter.georisk.gov.ph/geoserver/hazardhunter/wms',
    layers: 'hazardhunter:lh_combined',
    label: 'RAIN-INDUCED LANDSLIDE',
    legend: [{color:'#cc0000',label:'High'},{color:'#ff6600',label:'Medium'},{color:'#ffcc00',label:'Low'}]
  },
  storm: {
    url: 'https://hazardhunter.georisk.gov.ph/geoserver/hazardhunter/wms',
    layers: 'hazardhunter:ssa_level3',
    label: 'STORM SURGE ADVISORY',
    legend: [{color:'#0000ff',label:'SSA 3 (>3m)'},{color:'#0088ff',label:'SSA 2 (1-3m)'},{color:'#00ccff',label:'SSA 1 (<1m)'}]
  }
};

let currentBaseLayer = null;
let activeHazardLayer = null;
let currentLayerKey = 'street';
let currentHazardKey = null;


// ============================================================
// LAYER PANEL HELPERS (must be defined before initMap)
// ============================================================
function toggleLayerPanel(){
  const p = document.getElementById('layer-panel');
  if(p) p.classList.toggle('open');
}
document.addEventListener('click', function(e){
  const ctrl = document.getElementById('map-controls');
  if(ctrl && !ctrl.contains(e.target)){
    const p = document.getElementById('layer-panel');
    if(p) p.classList.remove('open');
  }
});
function updateBaseChecks(key){
  ['street','satellite','topo'].forEach(function(k){
    const c = document.getElementById('chk-'+k);
    if(c){ c.innerHTML = k===key ? '&#10003;' : ''; c.className='lp-check'+(k===key?' on':''); }
  });
}
function updateHazardCheck(key, on){
  const c = document.getElementById('chk-'+key);
  if(c){ c.innerHTML = on ? '&#10003;' : ''; c.className='lp-check'+(on?' hazard-on':''); }
}
function setHazardOpacity(val){
  if(typeof activeHazardLayer !== 'undefined' && activeHazardLayer) activeHazardLayer.setOpacity(val/100);
}

function initMap(){
  map = L.map('map',{zoomControl:true}).setView([CFG.lat, CFG.lng], 15);
  setLayer('street');
}

function setLayer(key){
  const cfg = TILE_LAYERS[key];
  if(!cfg) return;

  if(currentBaseLayer) map.removeLayer(currentBaseLayer);

  currentBaseLayer = L.tileLayer(cfg.url, {attribution:cfg.attr, maxZoom:cfg.maxZoom});
  currentBaseLayer.addTo(map);
  currentLayerKey = key;

  // Apply brightness filter to map tiles
  setTimeout(()=>{
    document.querySelectorAll('.leaflet-tile-pane img').forEach(img=>{
      img.style.filter = cfg.filter||'';
    });
  }, 300);

  updateBaseChecks(key);
}

function toggleHazard(key){
  const btn = document.getElementById('btn-'+key);
  const legend = document.getElementById('hazard-legend');

  // Turn off if same layer clicked again
  if(currentHazardKey === key){
    if(activeHazardLayer){ map.removeLayer(activeHazardLayer); activeHazardLayer=null; }
    currentHazardKey = null;
    ['flood','landslide','storm'].forEach(k=>updateHazardCheck(k,false));
    legend.style.display='none';
    return;
  }

  // Remove previous hazard
  if(activeHazardLayer){ map.removeLayer(activeHazardLayer); activeHazardLayer=null; }
  ['flood','landslide','storm'].forEach(k=>updateHazardCheck(k,false));

  const hcfg = HAZARD_LAYERS[key];
  if(!hcfg) return;

  // Try WMS first
  try {
    activeHazardLayer = L.tileLayer.wms(hcfg.url, {
      layers: hcfg.layers,
      format: 'image/png',
      transparent: true,
      opacity: 0.65,
      attribution: '¬© PHIVOLCS Hazard Hunter'
    });
    activeHazardLayer.addTo(map);
  } catch(e) {
    console.warn('WMS layer failed:', e);
    showHazardOfflineNotice(hcfg.label);
    return;
  }

  currentHazardKey = key;
  updateHazardCheck(key, true);

  // Show legend
  document.getElementById('leg-title').textContent = hcfg.label;
  document.getElementById('leg-rows').innerHTML = hcfg.legend.map(l=>
    `<div class="leg-row"><div class="leg-dot" style="background:${l.color}"></div>${l.label}</div>`
  ).join('');
  legend.style.display='block';
}

function showHazardOfflineNotice(label){
  addMessage({
    sender:'SYSTEM', post:'', type:'system', time:new Date().toLocaleTimeString('en-US',{hour12:false}),
    body:`Hazard layer "${label}" could not be loaded. Open https://hazardhunter.georisk.gov.ph directly for hazard maps.`
  });
}

function buildTeamFilters(){
  const bar = document.getElementById('team-filters');
  bar.innerHTML = `<button class="tf-btn active" onclick="filterTeam('ALL',this)">ALL</button>`;
  CFG.teams.forEach(t=>{
    const b = document.createElement('button');
    b.className = 'tf-btn';
    b.textContent = t.name.split(' ')[0]; // first word only to keep short
    b.onclick = ()=>{ filterTeam(t.name,b); };
    bar.appendChild(b);
  });
}

function buildLegend(){
  const leg = document.getElementById('legend');
  let html = '';
  CFG.teams.forEach(t=>{
    html += `<div class="leg-item"><div class="leg-dot" style="background:${t.color};box-shadow:0 0 4px ${t.color}80"></div><span style="color:${t.color};font-size:9px;letter-spacing:1px;opacity:.85;">${t.name}</span></div>`;
  });
  leg.innerHTML = html;
}

function filterTeam(name, btn){
  selectedTeamFilter = name;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderPersonnelList();
}

function startClock(){
  const u=()=>{ document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false}); };
  u(); setInterval(u,1000);
}

// ============================================================
// DATA FETCH
// ============================================================
async function fetchUpdates(){
  if(!SHEET_URL){ loadDemoData(); return; }
  try{
    const r = await fetch(`${SHEET_URL}?action=getAll`);
    const d = await r.json();
    if(d.personnel){
      console.log('[TMS] Personnel data:', JSON.stringify(d.personnel));
      updatePersonnel(d.personnel);
    }
    if(d.messages) updateMessages(d.messages);
  }catch(e){ console.warn('[TMS] Fetch error',e); }
}

// ============================================================
// DEMO DATA
// ============================================================
function loadDemoData(){
  const demo = [
    {id:'P1',name:'Ofc. Reyes',  team:'PARADE TEAM',      post:'North Checkpoint', lat:8.7901,lng:117.8360,online:true, lastSeen:'12:34'},
    {id:'P2',name:'Ofc. Santos', team:'PARADE TEAM',      post:'South Checkpoint', lat:8.7881,lng:117.8375,online:true, lastSeen:'12:34'},
    {id:'P3',name:'Ofc. Cruz',   team:'EVENT CENTER TEAM',post:'Main Stage',       lat:8.7895,lng:117.8395,online:true, lastSeen:'12:33'},
    {id:'P4',name:'Ofc. Bautista',team:'MOBILE TEAM',     post:'Patrol Route',     lat:8.7870,lng:117.8350,online:false,lastSeen:'12:10'},
  ];
  updatePersonnel(demo);
  if(logEntries.length===0){
    addMessage({sender:'SYSTEM',post:'',body:'Demo mode ‚Äî Google Sheets not connected yet.',type:'system',time:'--:--'});
    addMessage({sender:'Ofc. Reyes',post:'North Checkpoint',body:'All clear at north end. Crowd forming.',type:'personnel',time:'12:30',team:'PARADE TEAM'});
    addMessage({sender:'Ofc. Cruz',post:'Main Stage',body:'Stage area secure. VIPs arriving soon.',type:'personnel',time:'12:32',team:'EVENT CENTER TEAM'});
  }
}

// ============================================================
// PERSONNEL
// ============================================================
function updatePersonnel(list){
  // Sanitize ‚Äî Sheet sometimes returns strings
  list = list.map(p=>({
    ...p,
    lat: parseFloat(p.lat)||0,
    lng: parseFloat(p.lng)||0,
    online: p.online===true || p.online==='TRUE' || p.online==='true'
  }));
  list.forEach(p=>{
    const existing = personnelData[p.id];
    // If we already have this person with real GPS, don't overwrite with 0,0
    if(existing && (existing.lat||0)!==0 && (existing.lng||0)!==0 && (p.lat||0)===0 && (p.lng||0)===0){
      console.log('[TMS] Kept better GPS for',p.name,'- ignoring 0,0 duplicate row');
      return; // skip this bad row
    }
    personnelData[p.id]=p;
    console.log('[TMS] Person:',p.name,'online:',p.online,'lat:',p.lat,'lng:',p.lng);
  });

  // Auto-fit map to show all online personnel with valid GPS
  const online = list.filter(p=>p.online && (p.lat||0) !== 0 && (p.lng||0) !== 0);
  if(online.length>0 && !map._fitted){
    map.fitBounds(online.map(p=>[p.lat,p.lng]),{padding:[60,60]});
    map._fitted=true;
  }
  // If no online with GPS yet, keep default center but don't lock
  if(online.length===0) map._fitted=false;

  // Update markers
  list.forEach(p=>{
    if(p.online && (p.lat||0) !== 0 && (p.lng||0) !== 0) updateMarker(p);
    else removeMarker(p.id);
  });

  // Stats
  const total = list.length;
  const onlineCt = list.filter(p=>p.online).length;
  document.getElementById('online-count').textContent = `${onlineCt} / ${total}`;
  document.getElementById('online-badge').textContent = `${onlineCt} ONLINE`;

  renderPersonnelList();
}

function getTeamColor(teamName){
  const t = CFG.teams.find(t=>t.name===teamName);
  return t ? t.color : '#888';
}

function updateMarker(p){
  const color = getTeamColor(p.team);
  const initials = p.name.replace(/^(Ofc\.|PO|SPO|Insp\.)\s*/i,'').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  const glowColor = color.replace('#','');
  const html = `<div class="p-marker" style="background:${color};box-shadow:0 0 8px ${color}80;">${initials}</div>`;
  const icon = L.divIcon({html,className:'',iconSize:[18,18],iconAnchor:[9,9]});

  if(markers[p.id]){
    markers[p.id].setLatLng([p.lat,p.lng]);
    markers[p.id].setIcon(icon);
  } else {
    markers[p.id] = L.marker([p.lat,p.lng],{icon})
      .addTo(map)
      .bindPopup(`<b>${p.name}</b><br><span style="color:${color}">${p.team||''}</span><br>${p.post||''}<br><small>Last seen: ${p.lastSeen}</small>`);
  }
}

function removeMarker(id){
  if(markers[id]){ map.removeLayer(markers[id]); delete markers[id]; }
}

function renderPersonnelList(){
  const container = document.getElementById('personnel-list');
  const list = Object.values(personnelData);
  const filtered = selectedTeamFilter==='ALL' ? list : list.filter(p=>p.team===selectedTeamFilter);

  if(filtered.length===0){
    container.innerHTML='<div class="empty">No personnel in this team yet.</div>';
    return;
  }

  container.innerHTML='';
  // Sort: online first
  filtered.sort((a,b)=> (b.online?1:0)-(a.online?1:0));

  filtered.forEach(p=>{
    const color = getTeamColor(p.team);
    const card = document.createElement('div');
    card.className=`p-card ${p.online?'online':''} ${selectedTarget===p.id?'selected':''}`;
    card.style.borderLeftColor = p.online ? color : 'var(--dim)';
    card.innerHTML=`
      <div class="pc-name">${p.name}</div>
      <div class="pc-team" style="color:${color}">${p.team||''}</div>
      <div class="pc-post">üìç ${p.post||'No post assigned'}</div>
      <div class="pc-status ${p.online?'on':'off'}">${p.online?'‚óè ONLINE':'‚óã OFFLINE'}</div>
      <div class="pc-time">Last seen: ${p.lastSeen||'‚Äî'}</div>
      <div class="pc-actions">
        <button class="pc-btn" onclick="selectTarget('${p.id}','${p.name}')">MESSAGE</button>
        <button class="pc-btn" onclick="focusOn('${p.id}')">LOCATE</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function focusOn(id){
  const p = personnelData[id];
  if(p && p.lat && p.lng){
    map.setView([p.lat,p.lng],17);
    if(markers[id]) markers[id].openPopup();
  }
}

// ============================================================
// MESSAGING
// ============================================================
function selectTarget(id,name){
  selectedTarget=id;
  document.getElementById('target-label').textContent=name.toUpperCase();
  renderPersonnelList();
}

async function sendMessage(){
  const input=document.getElementById('cmd-input');
  const body=input.value.trim();
  if(!body) return;

  const msg={
    sender:CFG.commander||'PAGONG',
    post:'EOC',
    body,
    type:'commander',
    time:new Date().toLocaleTimeString('en-US',{hour12:false}),
    target:selectedTarget
  };
  addMessage(msg);
  input.value='';

  if(SHEET_URL){
    try{ await fetch(SHEET_URL,{method:'POST',body:JSON.stringify({action:'sendMessage',...msg})}); }catch(e){}
  }
}

function updateMessages(messages){
  messages.forEach(m=>{
    const key = `${m.time}_${m.sender}_${m.body}`;
    if(!messageCache.has(key)){
      messageCache.add(key);
      addMessage(m);
    }
  });
}

function addMessage(msg, save=true){
  const log=document.getElementById('msg-log');
  log.querySelectorAll('.empty').forEach(e=>e.remove());

  const item=document.createElement('div');
  item.className=`msg-item ${msg.type}`;
  const teamColor = msg.team ? getTeamColor(msg.team) : 'var(--accent)';
  item.innerHTML=`
    <div class="msg-hdr">
      <span class="msg-sender" style="color:${teamColor}">${msg.sender}${msg.post?` ¬∑ ${msg.post}`:''}</span>
      <span class="msg-time">${msg.time}</span>
    </div>
    <div>${msg.body}</div>
    ${msg.photoUrl?(()=>{
        // Convert drive.google.com/uc?id=X to embeddable thumbnail URL
        const raw = msg.photoUrl;
        const match = raw.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        const embedUrl = match
          ? 'https://lh3.googleusercontent.com/d/'+match[1]
          : raw;
        return `<div class="msg-photo-wrap">
          <img class="msg-photo" src="${embedUrl}"
            onclick="openPhoto('${embedUrl}','${raw}')"
            onerror="this.style.display='none';this.nextElementSibling.style.display='flex';"
            title="Click to enlarge"/>
          <a class="photo-fallback" href="${raw}" target="_blank" style="display:none;">
            üì∑ View Photo in Drive
          </a>
        </div>`;
      })():''}
  `;
  log.appendChild(item);
  log.scrollTop=log.scrollHeight;

  if(save){
    logEntries.push(msg);
    localStorage.setItem('parade_log_session', JSON.stringify(logEntries));
  }
}

// ============================================================
// PHOTO
// ============================================================
function openPhoto(url, fallback){
  const img = document.getElementById('pm-img');
  img.src = url;
  img.onerror = function(){
    // If embed fails, show drive link instead
    this.style.display='none';
    const fb = document.getElementById('pm-fallback');
    if(fb){ fb.href=fallback||url; fb.style.display='block'; }
  };
  document.getElementById('photo-modal').classList.add('show');
}
function closePhoto(){ document.getElementById('photo-modal').classList.remove('show'); }

// ============================================================
// DOWNLOAD LOG
// ============================================================
function downloadLog(){
  const header = `PARADE TMS ‚Äî Comms Log\nEvent: ${CFG.eventName||'‚Äî'} | Date: ${CFG.eventDate||'‚Äî'} | Commander: ${CFG.commander||'‚Äî'}\n${'='.repeat(60)}\n\n`;
  const body = logEntries.map(m=>`[${m.time}] ${m.sender}${m.post?` (${m.post})`:''}: ${m.body}`).join('\n');
  const blob = new Blob([header+body],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`TMS_Log_${(CFG.eventName||'Event').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
}


// ============================================================
// MAP MAXIMIZE
// ============================================================
let mapMaximized = false;
function toggleMapMax(){
  mapMaximized = !mapMaximized;
  document.body.classList.toggle('map-maximized', mapMaximized);
  const btn = document.getElementById('map-max-btn');
  if(btn) btn.textContent = mapMaximized ? '‚õ∂ RESTORE' : '‚õ∂ MAXIMIZE';
  setTimeout(function(){ map.invalidateSize(); }, 300);
}

// ============================================================
// FOOTER: smaller, hides after 1 min, reappears after 5 min
// ============================================================
(function footerCycle(){
  const footer = document.getElementById('pagong-footer');
  if(!footer) return;
  function hide(){
    footer.style.transition = 'opacity 1s';
    footer.style.opacity = '0';
    footer.style.pointerEvents = 'none';
    setTimeout(show, 5 * 60 * 1000); // reappear after 5 min
  }
  function show(){
    footer.style.transition = 'opacity 1s';
    footer.style.opacity = '1';
    footer.style.pointerEvents = '';
    setTimeout(hide, 60 * 1000); // hide again after 1 min
  }
  setTimeout(hide, 60 * 1000); // first hide after 1 min
})();

init();

// ============================================================
// JITSI VIDEO CONFERENCE
// ============================================================
let jitsiAPI = null;

function toggleJitsi(){
  const body = document.getElementById('jitsi-body');
  const status = document.getElementById('jitsi-hdr-status');
  body.classList.toggle('open');
  status.textContent = body.classList.contains('open') ? 'OPEN ‚ñ≤' : 'IDLE ‚ñº';
}

function joinJitsi(){
  const room = (document.getElementById('jitsi-room-in').value||'PARADE26-EOC').trim().replace(/\s+/g,'-');
  const wrap = document.getElementById('jitsi-wrap');
  // Remove old iframe if any
  wrap.innerHTML = '';
  // Use Jitsi public server via iframe ‚Äî no API key needed
  const iframe = document.createElement('iframe');
  iframe.src = `https://meet.jit.si/${encodeURIComponent(room)}`;
  iframe.allow = 'camera; microphone; fullscreen; display-capture; autoplay';
  iframe.style.cssText = 'width:100%;height:220px;border:none;display:block;';
  wrap.appendChild(iframe);
  // Update header dot
  document.getElementById('jitsi-dot').classList.add('live');
  document.getElementById('jitsi-hdr-status').innerHTML = '<span style="color:#ff4444">‚óè LIVE</span> ‚ñ≤';
  // Make sure panel is open
  document.getElementById('jitsi-body').classList.add('open');
}

function leaveJitsi(){
  const wrap = document.getElementById('jitsi-wrap');
  wrap.innerHTML = '<div id="jitsi-idle">‚ñ∂ Enter a room name and press JOIN<br/>to start a free video call</div>';
  document.getElementById('jitsi-dot').classList.remove('live');
  document.getElementById('jitsi-hdr-status').textContent = 'IDLE ‚ñº';
}

</script>

  <!-- PAGONG FOOTER -->
  <div id="pagong-footer" style="
    position:fixed;bottom:0;left:0;right:341px;
    background:transparent;border-top:none;
    padding:0 8px 2px 8px;display:flex;align-items:flex-end;
    justify-content:flex-start;z-index:500;pointer-events:none;
  ">
    <div style="font-size:7px;color:#c0d8f0;font-family:'Share Tech Mono',monospace;opacity:0.6;letter-spacing:0.4px;white-space:nowrap;text-shadow:0 0 4px rgba(0,0,0,0.9),0 1px 3px rgba(0,0,0,1);">
      JOEY S HEREDERO &nbsp;&middot;&nbsp; 09468206576 &nbsp;&middot;&nbsp; joeyherederopal@gmail.com &nbsp;&nbsp; &copy; 2026 ALL RIGHTS RESERVED
    </div>
  </div>

</body>

<!-- ============================================================
     PARADE TMS // EOC COMMANDER SYSTEM
     Copyright (c) 2026 JOEY S HEREDERO
     Contact: 09468206576 | joeyherederopal@gmail.com
     All rights reserved.
     ============================================================ -->
</html>
